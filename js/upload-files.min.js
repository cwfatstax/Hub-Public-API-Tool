var inputFiles,filenames,folderFileNames,fileStream,fileExtRegex,currIndex,accessToken,batchSize,jsdom=require("jsdom");const{JSDOM:JSDOM}=jsdom,{window:window}=new JSDOM("<html></html>");var $=require("jquery")(window);const request=require("request"),fs=require("fs"),Papa=require("./papaparse.min.js");function createFileNameArray(input){let tempFileNames=[];input.forEach((row,index)=>{let dupe=!1;if(""!=row["File Name"]){for(let i=0;i<index;i++)if(input[i]["File Name"]==row["File Name"]){dupe=!0;break}filenames.push({name:row["File Name"],skip:dupe}),tempFileNames.push(row["File Name"])}}),fs.readdir("../import_files",{withFileTypes:!0},(err,files)=>{files.forEach(file=>{".DS_Store"==file.name||(tempFileNames.includes(file.name)?folderFileNames.push(file.name):tempFileNames.includes(file.name))}),filenames.forEach((filename,index)=>{folderFileNames.includes(filename.name)||(filename.skip=!0)}),authClientCredentials()})}async function uploadFiles(files,startIndex){return new Promise(async(resolve,reject)=>{let req,form=request.post({url:"https://pubapi.bigtincan.com/v1/story/upload/file",headers:{Authorization:`Bearer ${accessToken}`,rhr:1},json:!0},(err,response,body)=>{if(err)console.error("error in uploading file",err),reject(err),downloadCSV(inputFiles);else if(body.error)console.error("error in uploading file",body.error),reject(body.error),downloadCSV(inputFiles);else{let hubFileNames={};console.log(`${body.data.length} File(s) uploaded`),resolve(body.data),console.log(body.data),body.data.forEach(file=>{let fullFileName=file.description+file.filename.match(fileExtRegex)[0];hubFileNames[fullFileName]=file.filename}),addHubFileNames(hubFileNames,startIndex),files.length<=currIndex?downloadCSV(inputFiles):(console.log("starting next batch.."),authClientCredentials())}}).form();form.append("upload_type","file"),files.slice(startIndex,startIndex+batchSize).forEach(filename=>{0==filename.skip&&(form.append("files[]",fs.createReadStream(`../import_files/${filename.name}`)),console.log("Adding: "+filename.name)),currIndex++})})}function authClientCredentials(){$.ajax({url:"https://pubapi.bigtincan.com/services/oauth2/token?",crossDomain:!0,method:"POST",dataType:"json",data:{grant_type:"password",client_id:"8631c75e30671e5386719b30840d0f12",client_secret:"57b7f6cd0e67416cd4cdb65a8e80bb3f4ea603ea204fc76273afecf4913db5b6",api_key:"aff60ba9853384bd9a661bbd519c4c8ff6952b1baf3cf77c6b748a39d99fe151"},success:function(res){void 0!==res.access_token&&void 0!==res.refresh_token&&(console.log("Client authorization successful!"),accessToken=res.access_token,console.log(res.access_token),uploadFiles(filenames,currIndex))},error:function(data){console.log(data.status+": "+data.statusText+" | "+data.responseText)}})}fileStream=fs.createReadStream("../data.csv"),filenames=[],currIndex=0,batchSize=50,folderFileNames=[],fileExtRegex=/\.[0-9a-z]+$/,Papa.parse(fileStream,{delimiter:",",header:!0,download:!1,complete:function(results,file){createFileNameArray(inputFiles=results.data)}});var addHubFileNames=function(hubFileNames,startIndex){inputFiles.slice(startIndex,startIndex+batchSize).forEach(row=>{""!=row["File Name"]&&(row["Hub File Name"]=hubFileNames[row["File Name"]])})},downloadCSV=function(data){var csv=Papa.unparse(data);fs.writeFile("../data-hub-files.csv",csv,err=>{if(err)throw err;console.log("csv created")})};